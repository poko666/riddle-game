<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è…¦ç­‹æ€¥è½‰å½å°éŠæˆ² ğŸ®</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00796b" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <meta name="description" content="åœ‹å°ç”Ÿå‹å–„çš„ä¸­æ–‡è…¦ç­‹æ€¥è½‰å½å°éŠæˆ²ï¼šèªéŸ³ä½œç­”ã€æç¤ºæ©Ÿåˆ¶ã€è¨ˆåˆ†èˆ‡é›¢ç·šæ”¯æ´ï¼ˆPWAï¼‰ã€‚" />

  <style>
    :root {
      --brand: #00796b;
      --brand-dark: #004d40;
      --bg1: #f9f9f9;
      --bg2: #e0f7fa;
      --ok: #c8e6c9;
      --bad: #ffcdd2;
      --text: #123;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Microsoft JhengHei", "Noto Sans TC", Arial, sans-serif;
      margin: 0;
      color: var(--text);
      background: linear-gradient(to right, var(--bg1), var(--bg2));
      -webkit-tap-highlight-color: transparent;
    }
    header {
      padding: 16px 20px 0;
      text-align: center;
    }
    h1 { margin: 0 0 8px; color: var(--brand); font-size: clamp(20px, 2.8vw + 14px, 28px); }
    .sub { font-size: 14px; opacity: .7; margin-bottom: 12px; }

    .container {
      max-width: 820px; margin: 0 auto; padding: 12px 16px 28px;
    }

    #gameCard {
      background: #fff;
      border-radius: 20px;
      padding: clamp(14px, 2.5vw + 8px, 28px);
      margin: 10px auto 14px;
      min-height: 120px;
      box-shadow: 0 8px 18px rgba(0,0,0,.15);
      font-size: clamp(18px, 2.2vw + 12px, 24px);
      display: flex; align-items: center; justify-content: center;
      text-align: center;
      transition: transform .4s, background .25s;
    }
    #gameCard.correct { background: var(--ok); transform: scale(1.03); }
    #gameCard.wrong   { background: var(--bad); transform: scale(.97); }

    .bar {
      width: 100%; height: 20px; background: #ddd; border-radius: 999px;
      overflow: hidden; margin: 10px 0;
    }
    #scoreProgress { height: 100%; width: 0%; background: var(--brand); transition: width .5s; }

    .hud {
      display: flex; justify-content: space-between; align-items: center;
      gap: 8px; flex-wrap: wrap;
      font-size: 16px; margin: 8px 0 4px;
    }
    .hint { margin: 8px 0 0; font-size: 16px; color: #555; min-height: 20px; }

    .cta {
      display: grid; grid-template-columns: repeat(2, 1fr);
      gap: 10px; margin-top: 12px;
    }
    .cta button, .row button {
      padding: 14px; font-size: 18px; border: none; border-radius: 12px;
      background: var(--brand); color: #fff; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,.12);
      transition: transform .08s ease, background .25s ease;
      touch-action: manipulation;
    }
    .cta button:active, .row button:active { transform: translateY(1px); background: var(--brand-dark); }

    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 8px; }
    input[type="text"] {
      width: 100%; padding: 14px; font-size: 18px; border-radius: 12px;
      border: 1px solid #c9d4d9; background: #fff;
    }

    /* å®‰è£æç¤ºå€ */
    .install {
      margin-top: 12px; display: none; text-align: center;
    }
    .install button { padding: 12px 16px; font-size: 16px; }

    footer {
      text-align: center; font-size: 12px; opacity: .6; padding: 16px 0 26px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‰ è…¦ç­‹æ€¥è½‰å½å°éŠæˆ²</h1>
    <div class="sub">èªéŸ³ä½œç­”ãƒ»3 æ¬¡æç¤ºãƒ»è¨ˆåˆ†ãƒ»å¯å®‰è£ (PWA)</div>
  </header>

  <main class="container" aria-live="polite">
    <div id="gameCard">é»ã€Œé–‹å§‹ã€å¾Œï¼Œé¡Œç›®æœƒå”¸å‡ºä¾†å–”ï¼</div>

    <div class="hud">
      <div id="score">åˆ†æ•¸ï¼š0</div>
      <div id="hints">æç¤ºå‰©é¤˜ï¼š3</div>
    </div>
    <div class="bar" aria-hidden="true"><div id="scoreProgress"></div></div>
    <div id="hint" class="hint"></div>

    <!-- æ‰‹æ©Ÿ/å¹³æ¿è¼¸å…¥å‚™æ´ï¼ˆiOS Safari ç„¡èªéŸ³è¾¨è­˜æ™‚ä½¿ç”¨ï¼‰ -->
    <div class="row">
      <input id="answerInput" type="text" inputmode="search" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆæˆ–é»ä¸‹æ–¹ã€èªéŸ³ä½œç­”ã€" />
      <button id="btnSubmit">é€å‡º</button>
    </div>

    <div class="cta">
      <button id="btnStart">é–‹å§‹</button>
      <button id="btnHint">æç¤º</button>
      <button id="btnGiveup">æ”¾æ£„</button>
      <button id="btnVoice">ğŸ¤ èªéŸ³ä½œç­”</button>
    </div>

    <!-- PWA å®‰è£æç¤º -->
    <div class="install" id="installBox">
      <p>æƒ³è¦åƒ App ä¸€æ¨£å®‰è£åœ¨æ‰‹æ©Ÿä¸»ç•«é¢å—ï¼Ÿ</p>
      <button id="btnInstall">å®‰è£åˆ°ä¸»ç•«é¢</button>
    </div>

    <!-- éŸ³æ•ˆ -->
    <audio id="soundCorrect" preload="auto" src="https://actions.google.com/sounds/v1/crowds/cheer.ogg"></audio>
    <audio id="soundWrong"   preload="auto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  </main>

  <footer>Â© 2025 Riddle Game Â· æ”¯æ´ Android/Chrome èªéŸ³ä½œç­”ï¼›iOS å¯ç”¨éµç›¤è¼¸å…¥</footer>

  <script>
    // ===== é¡Œåº«ï¼ˆå¯è‡ªè¡Œæ“´å……ï¼‰ =====
    let riddles = [];
    // è¼‰å…¥é¡Œåº«
    async function loadRiddles() {
        try {
        const res = await fetch("riddles.json");
        riddles = await res.json();
        console.log("ğŸ“¥ é¡Œåº«è¼‰å…¥å®Œæˆï¼Œå…±", riddles.length, "é¡Œ");
        } catch (err) {
        console.error("âŒ ç„¡æ³•è¼‰å…¥é¡Œåº«", err);
        }
    }

    // è¼‰å…¥å®Œæˆå¾Œå†å•Ÿå‹•éŠæˆ²
    loadRiddles().then(() => {
        updateHUD();
        // å¯ä»¥åœ¨é€™è£¡è‡ªå‹•å‘¼å« startGame() æˆ–ç­‰å¾…ç©å®¶é»ã€Œé–‹å§‹ã€
    });

    // ===== ç‹€æ…‹ =====
    let score = 0;
    let hintLimit = 3;
    let currentIndex = 0;
    let usedHint = false;

    // ===== DOM =====
    const $card = document.getElementById("gameCard");
    const $score = document.getElementById("score");
    const $hints = document.getElementById("hints");
    const $hint = document.getElementById("hint");
    const $progress = document.getElementById("scoreProgress");
    const $input = document.getElementById("answerInput");

    const $btnStart  = document.getElementById("btnStart");
    const $btnHint   = document.getElementById("btnHint");
    const $btnGiveup = document.getElementById("btnGiveup");
    const $btnVoice  = document.getElementById("btnVoice");
    const $btnSubmit = document.getElementById("btnSubmit");

    const sOK  = document.getElementById("soundCorrect");
    const sBad = document.getElementById("soundWrong");

    // ===== å·¥å…· =====
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} }
    function speak(text){
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-TW";
        window.speechSynthesis.cancel(); // é¿å…ç´¯ç©
        window.speechSynthesis.speak(u);
      } catch(e) {}
    }
    function updateHUD(){
      $score.textContent = `åˆ†æ•¸ï¼š${score}`;
      $hints.textContent = `æç¤ºå‰©é¤˜ï¼š${hintLimit}`;
      const progress = Math.round((score / (riddles.length * 10)) * 100);
      $progress.style.width = progress + "%";
    }
    function showQuestion(){
      usedHint = false;
      $hint.textContent = "";
      $input.value = "";
      $card.className = "";
      if(currentIndex < riddles.length){
        const q = riddles[currentIndex].q;
        $card.textContent = "é¡Œç›®ï¼š" + q;
        speak("é¡Œç›®ï¼š" + q);
        $input.focus();
      } else {
        $card.textContent = `ğŸ‰ éŠæˆ²çµæŸï¼ä½ çš„ç¸½åˆ†æ˜¯ ${score} åˆ†`;
        speak(`éŠæˆ²çµæŸï¼ä½ çš„ç¸½åˆ†æ˜¯ ${score} åˆ†`);
      }
    }

    // ===== äº’å‹• =====
    function startGame(){
      score = 0; hintLimit = 3; currentIndex = 0;
      shuffle(riddles);
      updateHUD(); showQuestion();
    }
    function useHint(){
      if(currentIndex >= riddles.length) return;
      if(hintLimit > 0 && !usedHint){
        $hint.textContent = "ğŸ’¡ æç¤ºï¼š" + riddles[currentIndex].hint;
        speak("æç¤ºï¼š" + riddles[currentIndex].hint);
        hintLimit--; usedHint = true; updateHUD();
      } else if(usedHint){
        speak("é€™é¡Œå·²ç¶“ç”¨éæç¤ºäº†ï¼");
      } else {
        speak("æç¤ºæ¬¡æ•¸å·²ç¶“ç”¨å®Œäº†ï¼");
      }
    }
    function giveUp(){
      if(currentIndex >= riddles.length) return;
      speak("æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š" + riddles[currentIndex].a);
      currentIndex++; showQuestion();
    }
    function checkAnswer(ans){
      if(currentIndex >= riddles.length) return;
      const a = riddles[currentIndex].a;
      if(!ans) return;
      if(ans.trim().includes(a)){
        speak("ç­”å°äº†ï¼åŠ ååˆ†ï¼");
        try { sOK.currentTime = 0; sOK.play(); } catch(e) {}
        score += 10; $card.className = "correct";
        updateHUD();
        setTimeout(()=>{ currentIndex++; showQuestion(); }, 900);
      } else {
        speak("ç­”éŒ¯äº†ï¼Œå†è©¦ä¸€æ¬¡ï¼");
        try { sBad.currentTime = 0; sBad.play(); } catch(e) {}
        $card.className = "wrong";
        setTimeout(()=>{ $card.className = ""; }, 700);
      }
    }
    // é€å‡ºï¼ˆéµç›¤ Enterï¼‰
    $input.addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ checkAnswer($input.value); }});

    // èªéŸ³
    function startListening() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) {
            alert("âš ï¸ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç”¨è¼¸å…¥ç­”æ¡ˆã€‚");
            return;
        }
        const r = new SR();
        r.lang = "zh-TW";
        r.continuous = true;       // å…è¨±æŒçºŒæ”¶éŸ³
        r.interimResults = true;   // ä¸­é€”çµæœ

        r.onresult = (ev) => {
            let text = ev.results[ev.results.length - 1][0].transcript;
            console.log("ğŸ¤ ä½ èªªï¼š", text);
            document.getElementById("answerInput").value = text; // å…ˆé¡¯ç¤º
        };

        r.onerror = (e) => {
            console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤", e);
            alert("èªéŸ³è¾¨è­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æ”¹ç”¨è¼¸å…¥æ¡†");
        };

        r.start();
    }

    // ç¶å®š
    $btnStart.addEventListener("click", startGame);
    $btnHint.addEventListener("click", useHint);
    $btnGiveup.addEventListener("click", giveUp);
    $btnVoice.addEventListener("click", startListening);
    $btnSubmit.addEventListener("click", ()=>checkAnswer($input.value));

    // åˆå§‹
    updateHUD();

    // ===== PWAï¼šService Worker è¨»å†Š =====
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("service-worker.js")
        .then(()=>console.log("SW registered"))
        .catch(err=>console.warn("SW register failed", err));
    }

    // ===== PWAï¼šå®‰è£æµç¨‹ï¼ˆbeforeinstallpromptï¼‰=====
    let deferredPrompt = null;
    const $installBox = document.getElementById("installBox");
    const $btnInstall = document.getElementById("btnInstall");

    window.addEventListener("beforeinstallprompt", (e)=>{
      e.preventDefault();            // æ””æˆªé è¨­å°æ¢
      deferredPrompt = e;
      $installBox.style.display = "block";
    });

    $btnInstall.addEventListener("click", async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log("Install choice:", outcome);
      deferredPrompt = null;
      $installBox.style.display = "none";
    });

    // iOS Safariï¼šé¡¯ç¤ºæç¤ºï¼ˆç„¡ beforeinstallpromptï¼‰
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isInStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
    if(isIOS && !isInStandalone){
      // ç°¡å–®æ–‡å­—æç¤ºï¼ˆå¯è‡ªè¡Œç¾åŒ–æˆæ•™å­¸åœ–ï¼‰
      $installBox.style.display = "block";
      $installBox.querySelector("p").textContent = "åœ¨ Safari ä»¥ã€Œåˆ†äº«ã€â†’ åŠ åˆ°ä¸»ç•«é¢ï¼Œå³å¯åƒ App ä½¿ç”¨ã€‚";
      $installBox.querySelector("button").style.display = "none";
    }
  </script>
</body>
</html>
